{% extends "base.html" %}
{% from "macros.html" import render_task_row, render_task_hierarchy %}

{% block content %}
<div class="auth-header" style="justify-content: flex-end; padding: 10px 0;">
    <div style="display: flex; align-items: center;">
        {% if user %}
        <span>Welcome, <strong>{{ user.name }}</strong></span>
        {% if user.picture %}
        <img src="{{ user.picture }}" alt="Avatar"
            style="width: 30px; border-radius: 50%; vertical-align: middle; margin: 0 5px;">
        {% endif %}

        <div class="settings-dropdown">
            <button class="settings-btn" onclick="toggleSettingsMenu()" title="Settings">
                &#9881; <!-- Gear Icon -->
            </button>
            <div id="settings-menu" class="dropdown-menu">
                <a href="{{ url_for('dashboard') }}">Information</a>
            </div>
        </div>

        <a href="{{ url_for('logout') }}" class="icon-btn" title="Logout"
            style="margin-left: 15px; color: #dc3545; font-size: 1.2em;">&#128682;</a>
        {% endif %}
    </div>
</div>

{% if user %}
<div class="app-container">
    {% include 'sidebar.html' %}

    <main class="main-content">
        <div style="margin-bottom: 20px;">
            <a href="{{ url_for('index') }}" style="text-decoration: none; color: #007bff;">&larr; Back to Tasks</a>
        </div>

        {# Main Task Header #}
        {# Main Task Header - Title integrated into row below #}
        <div style="margin-bottom: 20px;">

            {# Use the macro specifically for the row controls (status, menu, badges) #}
            {# Use the macro specifically for the row controls (status, menu, badges) #}
            <div class="main-task-row-container"
                style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                {{ render_task_row(task, 0) }}

                {# Hidden Form for Date Picker (REQUIRED for calendar.js) #}
                <form id="form-update-{{ task.id }}" action="/update_task" method="POST" style="display: none;">
                    <input type="hidden" name="task_id" value="{{ task.id }}">
                    <input type="hidden" name="due_at" id="due-at-{{ task.id }}"
                        value="{{ task.due_at.isoformat() if task.due_at and task.due_at is not string else task.due_at if task.due_at else '' }}">
                    <input type="hidden" name="title" value="{{ task.title }}">
                </form>

                {# Tags for Main Task #}
                <div id="main-task-tags" style="display: flex; gap: 5px; flex-wrap: wrap; margin-left: 10px;">
                    {% if task.tags %}
                    {% for tag in task.tags %}
                    <span class="tag-badge">
                        {{ tag.name }}
                        <a href="{{ url_for('remove_tag', task_id=task.id, tag_id=tag.id) }}" class="tag-remove"
                            title="Remove tag">x</a>
                    </span>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            <style>
                /* Custom styles for the main task in detail view */
                .main-task-row-container .task-title {
                    color: red !important;
                    font-size: 1.5em !important;
                    font-weight: bold !important;
                    cursor: default !important;
                    pointer-events: none !important;
                    text-decoration: none !important;
                }

                /* Hide the checkbox for the main title if desired? User didn't ask, but "Title of main task red" implies focus. 
                   User said "Move next to it all the buttons...". Checkbox is usually left of title. 
                   I will leave checkbox unless asked to remove.
                */

                /* Custom Quill Overrides for "No Frame" look */
                .ql-container.ql-snow {
                    border: none !important;
                }

                /* Toolbar Toggle Styles */
                .toolbar-toggle-btn {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    z-index: 1001;
                    background: #f8f9fa;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    padding: 2px 6px;
                    cursor: pointer;
                    font-size: 14px;
                    color: #555;
                    opacity: 0.3;
                    transition: opacity 0.2s, background 0.2s;
                }

                .toolbar-toggle-btn:hover {
                    opacity: 1;
                    background: #e9ecef;
                }

                #task-description-wrapper .ql-toolbar.ql-snow {
                    display: none;
                    border: none;
                    border-bottom: 1px solid #eee;
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: white;
                    z-index: 1000;
                }

                #task-description-wrapper.show-toolbar .ql-toolbar.ql-snow {
                    display: block;
                }

                #task-description-wrapper.show-toolbar .ql-container.ql-snow {
                    padding-top: 40px;
                    /* Space for toolbar */
                }

                #task-description-wrapper.show-toolbar .toolbar-toggle-btn {
                    opacity: 1;
                    background: #007bff;
                    color: white;
                    border-color: #007bff;
                }
            </style>

            {# Detailed Description #}
            {# Detailed Description (Rich Text Editor) #}
            <div id="task-description-wrapper"
                style="margin-bottom: 20px; position: relative; border: 1px solid transparent; transition: border 0.2s;">
                <span id="save-status"
                    style="font-size: 0.8em; display: none; position: absolute; top: -20px; right: 0; z-index: 1002;">Saving...</span>

                <!-- Toolbar Toggle Button -->
                <button type="button" class="toolbar-toggle-btn" onclick="DescriptionEditor.toggleToolbar()"
                    title="Toggle Toolbar">‚úé</button>

                <!-- Quill Editor Container -->
                <div id="task-description-editor" style="height: 200px; font-size: 16px;">{{ task.description | safe if
                    task.description else '' }}</div>
            </div>

            {# AI Suggestions #}
            {% if task.ai_suggestion %}
            <div style="margin-bottom: 20px;">
                <h3 style="color: #666; font-size: 0.9em; text-transform: uppercase;">AI Suggestions</h3>
                {% from "macros.html" import render_ai_suggestions %}
                {{ render_ai_suggestions(task) }}
            </div>
            {% endif %}
        </div>

        {# Subtasks Section #}
        <div style="margin-top: 20px;">
            {# Subtasks Header Removed #}

            {# Subtask Form #}
            <div style="margin-bottom: 20px;">
                {% from "macros.html" import render_task_forms %}

                <form action="/add_task" method="POST"
                    style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="hidden" name="parent_id" value="{{ task.id }}">
                    <input type="hidden" name="due_at" id="due-at-root" value="">

                    <input type="text" name="title" placeholder="Add a subtask..." required
                        style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">

                    <button type="button" class="icon-btn" onclick="openTimeSetDialog('root')"
                        title="Set Due Time">üïê</button>
                    <span id="due-preview-root" class="due-preview" onclick="openTimeSetDialog('root')"
                        style="font-size: 0.85em; background: #fff3cd; padding: 4px 8px; border-radius: 4px; display: none; cursor: pointer;">
                        <span class="due-preview-text"></span>
                    </span>

                    <input type="number" name="time_minutes" placeholder="Min" style="width: 60px; padding: 8px;">

                    <button type="submit"
                        style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
                </form>
            </div>

            {# Children List #}
            <div class="task-list">
                {% if children %}
                {% for child in children %}
                {{ render_task_hierarchy(child, now, 0) }}
                {% endfor %}
                {% endif %}
            </div>
        </div>

        {# Hidden Forms for Menu Actions #}
        {% from "macros.html" import render_task_forms %}
        {{ render_task_forms(task, now) }}
</div>
</main>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Global variable for calendar.js (if we want to use defaults in detail view too, though sidebar periods link to index)
    // We can just pass the period or default to 'today'
    window.globalCurrentPeriod = "{{ current_period or 'today' }}";

    // Initialize Quill Editor
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof DescriptionEditor !== 'undefined') {
            DescriptionEditor.init('{{ task.id }}');
        }
    });
</script>
<!-- Quill Styles -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<!-- Quill JS and Image Resize Module -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
<script src="{{ url_for('static', filename='js/description_editor.js') }}"></script>
{% endblock %}