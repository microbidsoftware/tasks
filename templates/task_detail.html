{% extends "base.html" %}
{% from "macros.html" import render_task_row, render_task_hierarchy %}

{% block content %}
<div class="auth-header" style="justify-content: flex-end; padding: 10px 0;">
    <div style="display: flex; align-items: center;">
        {% if user %}
        <span>Welcome, <strong>{{ user.name }}</strong></span>
        {% if user.picture %}
        <img src="{{ user.picture }}" alt="Avatar"
            style="width: 30px; border-radius: 50%; vertical-align: middle; margin: 0 5px;">
        {% endif %}

        <div class="settings-dropdown">
            <button class="settings-btn" onclick="toggleSettingsMenu()" title="Settings">
                &#9881; <!-- Gear Icon -->
            </button>
            <div id="settings-menu" class="dropdown-menu">
                <a href="{{ url_for('dashboard') }}">Information</a>
            </div>
        </div>

        <a href="{{ url_for('logout') }}" class="icon-btn" title="Logout"
            style="margin-left: 15px; color: #dc3545; font-size: 1.2em;">&#128682;</a>
        {% endif %}
    </div>
</div>

{% if user %}
<div class="app-container">
    {% include 'sidebar.html' %}

    <main class="main-content">
        <div style="margin-bottom: 20px;">
            <a href="{{ url_for('index') }}" style="text-decoration: none; color: #007bff;">&larr; Back to Tasks</a>
        </div>

        {# Main Task Header #}
        {# Main Task Header - Title integrated into row below #}
        <div style="margin-bottom: 20px;">

            {# Use the macro specifically for the row controls (status, menu, badges) #}
            <div class="main-task-row-container"
                style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                {{ render_task_row(task, 0) }}

                {# Hidden Form for Date Picker (REQUIRED for calendar.js) #}
                <form id="form-update-{{ task.id }}" action="/update_task" method="POST" style="display: none;">
                    <input type="hidden" name="task_id" value="{{ task.id }}">
                    <input type="hidden" name="due_at" id="due-at-{{ task.id }}"
                        value="{{ task.due_at.isoformat() if task.due_at and task.due_at is not string else task.due_at if task.due_at else '' }}">
                    <input type="hidden" name="title" value="{{ task.title }}">
                </form>
            </div>

            <style>
                /* Custom styles for the main task in detail view */
                .main-task-row-container .task-title {
                    color: red !important;
                    font-size: 1.5em !important;
                    font-weight: bold !important;
                    cursor: default !important;
                    pointer-events: none !important;
                    text-decoration: none !important;
                }

                /* Hide the checkbox for the main title if desired? User didn't ask, but "Title of main task red" implies focus. 
                   User said "Move next to it all the buttons...". Checkbox is usually left of title. 
                   I will leave checkbox unless asked to remove.
                */
            </style>

            {# Detailed Description #}
            {% if task.description %}
            <div style="margin-bottom: 20px;">
                <h3 style="color: #666; font-size: 0.9em; text-transform: uppercase;">Description</h3>
                <div
                    style="white-space: pre-wrap; color: #444; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                    {{ task.description }}</div>
            </div>
            {% endif %}

            {# AI Suggestions #}
            {% if task.ai_suggestion %}
            <div style="margin-bottom: 20px;">
                <h3 style="color: #666; font-size: 0.9em; text-transform: uppercase;">AI Suggestions</h3>
                {% from "macros.html" import render_ai_suggestions %}
                {{ render_ai_suggestions(task) }}
            </div>
            {% endif %}
        </div>

        {# Subtasks Section #}
        <div style="margin-top: 20px;">
            {# Subtasks Header Removed #}

            {# Subtask Form #}
            <div style="margin-bottom: 20px;">
                {% from "macros.html" import render_task_forms %}

                <form action="/add_task" method="POST"
                    style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="hidden" name="parent_id" value="{{ task.id }}">
                    <input type="hidden" name="due_at" id="due-at-root" value="">

                    <input type="text" name="title" placeholder="Add a subtask..." required
                        style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">

                    <button type="button" class="icon-btn" onclick="openTimeSetDialog('root')"
                        title="Set Due Time">üïê</button>
                    <span id="due-preview-root" class="due-preview" onclick="openTimeSetDialog('root')"
                        style="font-size: 0.85em; background: #fff3cd; padding: 4px 8px; border-radius: 4px; display: none; cursor: pointer;">
                        <span class="due-preview-text"></span>
                    </span>

                    <input type="number" name="time_minutes" placeholder="Min" style="width: 60px; padding: 8px;">

                    <button type="submit"
                        style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
                </form>
            </div>

            {# Children List #}
            <div class="task-list">
                {% if children %}
                {% for child in children %}
                {{ render_task_hierarchy(child, now, 0) }}
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </main>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Global variable for calendar.js (if we want to use defaults in detail view too, though sidebar periods link to index)
    // We can just pass the period or default to 'today'
    window.globalCurrentPeriod = "{{ current_period or 'today' }}";
</script>
{% endblock %}