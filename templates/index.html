{% extends 'base.html' %}

{% block content %}


<div class="auth-header">
    <h1>Tasks</h1>
    <div style="display: flex; align-items: center;">
        {% if user %}
        <span>Welcome, <strong>{{ user.name }}</strong></span>
        {% if user.picture %}
        <img src="{{ user.picture }}" alt="Avatar"
            style="width: 30px; border-radius: 50%; vertical-align: middle; margin: 0 5px;">
        {% endif %}

        <div class="settings-dropdown">
            <button class="settings-btn" onclick="toggleSettingsMenu()" title="Settings">
                &#9881; <!-- Gear Icon -->
            </button>
            <div id="settings-menu" class="dropdown-menu">
                <a href="{{ url_for('dashboard') }}">Information</a>
            </div>
        </div>

        <a href="{{ url_for('logout') }}" class="icon-btn" title="Logout"
            style="margin-left: 15px; color: #dc3545; font-size: 1.2em;">&#128682;</a>
        {% else %}
        <a href="{{ url_for('login') }}" class="button" style="font-weight: bold; color: blue;">Login with Google</a>
        {% endif %}
    </div>
</div>
{% if user %}
<div class="app-container">
    {% include 'sidebar.html' %}

    <main class="main-content">
        {# Search and Filtering UI #}


        {% from "macros.html" import render_task_hierarchy %}


        <div>
            <form action="/add_task" method="POST"
                style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <input type="hidden" name="due_at" id="due-at-root" value="">
                <input type="text" name="title" placeholder="Do what?" required style="width: 300px">
                <button type="button" class="icon-btn" onclick="openTimeSetDialog('root')" title="Set Due Time">
                    üïê
                </button>
                <span id="due-preview-root" class="due-preview" onclick="openTimeSetDialog('root')"
                    style="font-size: 0.85em; color: #856404; background: #fff3cd; border-radius: 4px; padding: 4px 8px; margin-left: 2px; cursor: pointer; border: 1px solid #ffeeba; display: none;">
                    <span class="due-preview-text"></span>
                </span>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="number" name="time_minutes" placeholder="000" style="width: 50px" min="0" max="999">
                    <span style="font-size: 0.9em; color: #666;">min</span>
                </div>
                <select name="importance"
                    style="font-size: 0.9em; padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="">None</option>
                    <option value="Important">Important</option>
                    <option value="Medium">Medium</option>
                    <option value="Not important">Not important</option>
                </select>
                <button type="submit"
                    style="border-radius: 20px; padding: 8px 20px; background-color: #28a745; color: white; border: none; cursor: pointer;">Add
                    Task</button>
                <div style="display: none; width: 100%; margin-top: 10px;">
                    <textarea name="description" placeholder="Description (optional)" rows="3"
                        style="width: 100%; border-radius: 8px; border: 1px solid #ccc; padding: 10px;"></textarea>
                </div>
            </form>
        </div>

        <div>

            <div class="task-list">
                {% for task in tasks if task.status != 'completed' %}
                {{ render_task_hierarchy(task, now, 0) }}
                {% else %}
                <p style="color: #777; font-style: italic;">No active tasks.</p>
                {% endfor %}
            </div>
        </div>

        <div style="margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px;">
            <h2 style="color: #555; display: flex; align-items: center; gap: 10px;">
                <a href="{{ url_for('toggle_completed_visibility') }}"
                    style="text-decoration: none; color: inherit; font-size: 0.8em; cursor: pointer;">
                    {% if user.show_completed_tasks %}‚ñº{% else %}‚ñ∂{% endif %}
                </a>
                Completed Tasks
            </h2>
            {% if user.show_completed_tasks %}
            <div class="task-list" style="opacity: 0.8;">
                {% for task in tasks if task.status == 'completed' %}
                {{ render_task_hierarchy(task, now, 0) }}
                {% else %}
                <p style="color: #777; font-style: italic;">No completed tasks yet.</p>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <script>
            // Global variable for calendar.js
            window.globalCurrentPeriod = "{{ current_period }}";
        </script>



    </main>
</div>
{% endif %} {# End if user #}

<script>
    // Global variable for calendar.js
    window.globalCurrentPeriod = "{{ current_period }}";
</script>
{% endblock %}