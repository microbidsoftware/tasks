{% extends 'base.html' %}

{% block content %}
<style>
    .task-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #fff;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .task-title {
        cursor: pointer;
        padding: 2px 5px;
        border-radius: 4px;
    }

    .task-title:hover {
        background-color: #f9f9f9;
    }

    .icon-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0 4px;
        color: #555;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        outline: none;
    }

    .icon-btn:hover {
        opacity: 0.8;
    }

    .edit-icon {
        color: #ffc107;
    }

    .delete-icon {
        color: #dc3545;
    }

    .subtask-icon {
        color: #17a2b8;
        font-size: 1.0em;
        font-weight: bold;
    }

    .icon-disabled {
        color: #ccc !important;
        cursor: not-allowed;
        pointer-events: none;
    }

    .auth-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .ai-suggestion-container .clear-ai-btn {
        visibility: hidden;
    }

    .ai-suggestion-container:hover .clear-ai-btn {
        visibility: visible;
    }

    .task-actions {
        visibility: hidden;
    }

    .task-row:hover .task-actions {
        visibility: visible;
    }

    /* Hide Dropdown Menu */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background-color: #f9f9f9;
        min-width: 120px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        border-radius: 4px;
    }

    .dropdown-content a {
        color: black;
        padding: 8px 12px;
        text-decoration: none;
        display: block;
        font-size: 0.9em;
    }

    .dropdown-content a:hover {
        background-color: #f1f1f1;
    }

    .show {
        display: block;
    }
</style>

<div class="auth-header">
    <h1>Tasks</h1>
    <div>
        {% if user %}
        <span>Welcome, <strong>{{ user.name }}</strong></span>
        {% if user.picture %}
        <img src="{{ user.picture }}" alt="Avatar"
            style="width: 30px; border-radius: 50%; vertical-align: middle; margin: 0 5px;">
        {% endif %}
        <a href="{{ url_for('logout') }}" class="button" style="margin-left: 10px; color: red;">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}" class="button" style="font-weight: bold; color: blue;">Login with Google</a>
        {% endif %}
    </div>
</div>

{% if not user %}
<div style="text-align: center; margin-top: 50px;">
    <h2>Please log in to manage your tasks.</h2>
    <p>Your tasks are private and secure.</p>
</div>
{% else %}

{# Macro for Recursive Task Rendering #}
{% macro render_task(task, level=0) %}
<div style="margin-left: {{ level * 30 }}px; padding-left: 10px; margin-bottom: 5px;">
    <div class="task-row">
        <div style="flex-grow: 1;">
            {# Importance Badge #}
            {% if task.importance and task.importance != '' %}
            <span class="badge" style="font-size: 0.8em; margin-left: 5px; padding: 2px 5px; border-radius: 4px;
                {% if task.importance == 'Important' %}background: #dc3545; color: white;
                {% elif task.importance == 'Medium' %}background: #ffc107; color: black;
                {% else %}background: #6c757d; color: white;{% endif %}">
                {{ task.importance }}
            </span>
            {% endif %}
            <span class="task-title {% if task.status == 'completed' %}completed{% endif %}"
                onclick="toggleForm('edit-form-{{ task.id }}')" title="Click to edit">
                {{ task.title }}
            </span>

            {# Time Display - Branch Only, Excluding Completed #}
            <span class="badge"
                style="font-size: 0.8em; color: #555; background: #f0f0f0; padding: 2px 5px; border-radius: 4px; margin-left: 10px;">
                {% if task.time_minutes %}
                {{ task.time_minutes }}m
                {% else %}
                -
                {% endif %}
                {% if task.children %} | Total: {{ task.branch_total }}m{% endif %}
            </span>

            {% if task.status != 'pending' %}
            <span class="badge" style="font-size: 0.8em; color: #666; margin-left: 5px;">({{ task.status }})</span>
            {% endif %}

            {% if task.ai_suggestion and task.status != 'completed' %}
            <div class="ai-suggestion-container"
                style="font-size: 0.85em; color: #0056b3; margin-top: 5px; background: #f8fbff; padding: 8px; border-radius: 6px; border-left: 3px solid #007bff; display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex-grow: 1;">
                    {% if task.ai_suggestion is string %}
                    <span style="font-style: italic;">AI: {{ task.ai_suggestion }}</span>
                    {% else %}
                    <ul style="margin: 0; padding-left: 15px; list-style-type: circle;">
                        {% for item in task.ai_suggestion %}
                        {# Handle both legacy strings and new objects #}
                        {% set item_text = item.text if item is mapping else item %}
                        {% set is_done = item.done if item is mapping else false %}
                        <li
                            style="margin-bottom: 4px; display: flex; align-items: start; justify-content: space-between;">
                            <span
                                style="flex-grow: 1; {% if is_done %}text-decoration: line-through; color: #999;{% endif %}">{{
                                item_text }}</span>
                            <div style="display: flex; gap: 4px; margin-left: 10px; align-items: center;">
                                {# Toggle/Checkmark Icon #}
                                <a href="{{ url_for('toggle_suggestion_item', task_id=task.id, text=item_text) }}"
                                    class="icon-btn" style="color: #007bff; font-size: 1.1em;" title="Mark as Done">
                                    {% if is_done %}&#9111;{% else %}&#10003;{% endif %}
                                </a>

                                {# Add as Subtask Icon #}
                                <form action="/add_task" method="POST" style="display: inline;">
                                    <input type="hidden" name="parent_id" value="{{ task.id }}">
                                    <input type="hidden" name="title" value="{{ item_text }}">
                                    <button type="submit" class="icon-btn"
                                        style="color: #28a745; font-weight: bold; font-size: 1.2em; background: transparent;"
                                        title="Add as subtask">+</button>
                                </form>

                                {# Remove Item Icon #}
                                <a href="{{ url_for('remove_suggestion_item', task_id=task.id, text=item_text) }}"
                                    class="icon-btn" style="color: #dc3545; font-size: 1.0em;"
                                    title="Remove Suggestion">&times;</a>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                <a href="{{ url_for('clear_suggestion', task_id=task.id) }}" class="icon-btn delete-icon clear-ai-btn"
                    style="font-size: 1.5em; margin-left: 15px; line-height: 1; color: #aaa; align-self: center;"
                    title="Clear All Suggestions">&times;&times;</a>
            </div>
            {% endif %}

            {# Description Display #}
            {% if task.description %}
            <div
                style="display: none; font-size: 0.85em; color: #444; margin-top: 4px; white-space: pre-wrap; border-top: 1px solid #f0f0f0; padding-top: 2px;">
                {{ task.description }}</div>
            {% endif %}
        </div>

        <div class="task-actions" style="display: flex; align-items: center; gap: 5px;">
            {% if task.status != 'completed' %}
            <a href="{{ url_for('complete_task', task_id=task.id) }}" class="icon-btn" title="Complete">
                &#10003; {# Checkmark #}
            </a>
            {% else %}
            <a href="{{ url_for('uncomplete_task', task_id=task.id) }}" class="icon-btn" title="Undo Completion">
                &#8617; {# Undo (Reply arrow) #}
            </a>
            {% endif %}

            {# Edit Icon #}
            {% if task.status != 'completed' %}
            <button onclick="toggleForm('edit-form-{{ task.id }}')" class="icon-btn edit-icon" title="Edit">
                &#9998; {# Pencil #}
            </button>
            {% else %}
            <button class="icon-btn icon-disabled" title="Cannot edit completed task" disabled>
                &#9998; {# Pencil #}
            </button>
            {% endif %}

            {# Delete Icon #}
            <a href="{{ url_for('delete_task', task_id=task.id) }}" class="icon-btn delete-icon" title="Delete">
                &#128465; {# Trash Bin #}
            </a>

            {# Add Subtask #}
            {% if task.status != 'completed' %}
            <button onclick="toggleForm('subtask-form-{{ task.id }}')" class="icon-btn subtask-icon"
                title="Add Subtask">
                +
            </button>
            {% else %}
            <button class="icon-btn icon-disabled" title="Cannot add subtask to completed task" disabled>
                +
            </button>
            {% endif %}

            {# Hide Button #}
            <div class="dropdown">
                <button onclick="toggleHideMenu('hide-menu-{{ task.id }}')" class="icon-btn" title="Hide Task">
                    &#128065; {# Eye icon #}
                </button>
                <div id="hide-menu-{{ task.id }}" class="dropdown-content">
                    <a href="{{ url_for('hide_task', task_id=task.id, duration='1 day') }}">1 day</a>
                    <a href="{{ url_for('hide_task', task_id=task.id, duration='2 days') }}">2 days</a>
                    <a href="{{ url_for('hide_task', task_id=task.id, duration='3 days') }}">3 days</a>
                    <a href="{{ url_for('hide_task', task_id=task.id, duration='1 week') }}">1 week</a>
                    <a href="{{ url_for('hide_task', task_id=task.id, duration='2 weeks') }}">2 weeks</a>
                    <a href="{{ url_for('hide_task', task_id=task.id, duration='1 month') }}">1 month</a>
                </div>
            </div>
        </div>
    </div>
</div>

{# Edit Form (Hidden by default) #}
<div id="edit-form-{{ task.id }}"
    style="display: none; margin-top: 5px; margin-left: 20px; background: #fff3cd; padding: 5px;">
    <form action="/update_task" method="POST" style="display: flex; gap: 5px; align-items: center;">
        <input type="hidden" name="task_id" value="{{ task.id }}">
        <input type="text" name="title" value="{{ task.title }}" required style="width: 200px;">
        <select name="importance" style="font-size: 0.9em; padding: 2px;">
            <option value="">None</option>
            <option value="Important" {% if task.importance=='Important' %}selected{% endif %}>Important</option>
            <option value="Medium" {% if task.importance=='Medium' %}selected{% endif %}>Medium</option>
            <option value="Not important" {% if task.importance=='Not important' %}selected{% endif %}>Not important
            </option>
        </select>
        <input type="number" name="time_minutes" value="{{ task.time_minutes if task.time_minutes else 0 }}"
            style="width: 60px;">
        <button type="submit" style="font-size: 0.8em; background-color: #ffc107; color: #000;">Save</button>
        <div style="display: none; width: 100%; margin-top: 5px;">
            <textarea name="description" placeholder="Description (optional)" rows="4"
                style="width: 100%; font-size: 0.9em;">{{ task.description if task.description else '' }}</textarea>
        </div>
    </form>
</div>

{# Subtask Form (Hidden by default) #}
<div id="subtask-form-{{ task.id }}" style="display: none; margin-top: 5px; margin-left: 20px;">
    <form action="/add_task" method="POST" style="display: flex; gap: 5px; align-items: center;">
        <input type="hidden" name="parent_id" value="{{ task.id }}">
        <input type="text" name="title" placeholder="Subtask title" required style="width: 200px;">
        <input type="number" name="time_minutes" placeholder="Mins" style="width: 60px;">
        <select name="importance" style="font-size: 0.8em; padding: 2px;">
            <option value="">None</option>
            <option value="Important">Important</option>
            <option value="Medium">Medium</option>
            <option value="Not important">Not important</option>
        </select>
        <button type="submit" style="font-size: 0.8em;">Add</button>
        <div style="display: none; width: 100%; margin-top: 5px;">
            <textarea name="description" placeholder="Subtask description (optional)" rows="3"
                style="width: 100%; font-size: 0.9em;"></textarea>
        </div>
    </form>
</div>

{# Render Children #}
{% if task.children %}
<div class="children">
    {% for child in task.children %}
    {{ render_task(child, level + 1) }}
    {% endfor %}
</div>
{% endif %}
</div>
{% endmacro %}

<div>
    <form action="/add_task" method="POST" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
        <input type="text" name="title" placeholder="Enter root task title" required style="width: 300px">
        <div style="display: flex; align-items: center; gap: 5px;">
            <input type="number" name="time_minutes" placeholder="000" style="width: 50px" min="0" max="999">
            <span style="font-size: 0.9em; color: #666;">min</span>
        </div>
        <select name="importance" style="font-size: 0.9em; padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="">None</option>
            <option value="Important">Important</option>
            <option value="Medium">Medium</option>
            <option value="Not important">Not important</option>
        </select>
        <button type="submit"
            style="border-radius: 20px; padding: 8px 20px; background-color: #28a745; color: white; border: none; cursor: pointer;">Add
            Task</button>
        <div style="display: none; width: 100%; margin-top: 10px;">
            <textarea name="description" placeholder="Description (optional)" rows="3"
                style="width: 100%; border-radius: 8px; border: 1px solid #ccc; padding: 10px;"></textarea>
        </div>
    </form>
</div>

<div>

    <div class="task-list">
        {% for task in tasks if task.status != 'completed' %}
        {{ render_task(task) }}
        {% else %}
        <p style="color: #777; font-style: italic;">No active tasks.</p>
        {% endfor %}
    </div>
</div>

<div style="margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px;">
    <h2 style="color: #555;">Completed Tasks</h2>
    <div class="task-list" style="opacity: 0.8;">
        {% for task in tasks if task.status == 'completed' %}
        {{ render_task(task) }}
        {% else %}
        <p style="color: #777; font-style: italic;">No completed tasks yet.</p>
        {% endfor %}
    </div>
</div>

<script>
    function toggleForm(id) {
        const form = document.getElementById(id);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function toggleHideMenu(id) {
        // Close all other dropdowns
        var dropdowns = document.getElementsByClassName("dropdown-content");
        for (var i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
            if (openDropdown.id !== id && openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
            }
        }
        document.getElementById(id).classList.toggle("show");
    }

    // Close the dropdown if the user clicks outside of it
    window.onclick = function (event) {
        if (!event.target.matches('.icon-btn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }
</script>

{% endif %} {# End if user #}
{% endblock %}